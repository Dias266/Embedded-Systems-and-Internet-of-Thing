<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vehicle Telematics Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-900 text-white">
    <div class="container mx-auto p-6">
        <!-- Header -->
        <div class="bg-gradient-to-r from-green-900 to-blue-900 p-6 rounded-lg mb-6">
            <h1 class="text-4xl font-bold mb-2"> Vehicle Telematics Dashboard</h1>
            <p class="text-xl text-gray-300">Real-Time Monitoring & Authentication</p>
            <p class="text-sm text-gray-400 mt-2">VIN: 1HGCM82633A123456 | Embedded Systems & IoT Project</p>
        </div>

        <!-- Status Cards -->
        <div class="grid grid-cols-4 gap-4 mb-6">
            <div class="bg-gray-800 p-4 rounded-lg border-l-4 border-blue-500">
                <div class="text-sm text-gray-400">CURRENT TEMPERATURE</div>
                <div id="current-temp" class="text-3xl font-bold">--</div>
                <div class="text-xs text-blue-400 mt-1">Real-time from ESP32</div>
            </div>
            <div class="bg-gray-800 p-4 rounded-lg border-l-4 border-green-500">
                <div class="text-sm text-gray-400">SYSTEM STATE</div>
                <div id="system-state" class="text-3xl font-bold">NORMAL</div>
                <div class="text-xs text-green-400 mt-1">FSM Status</div>
            </div>
            <div class="bg-gray-800 p-4 rounded-lg border-l-4 border-purple-500">
                <div class="text-sm text-gray-400">AUTHENTICATION</div>
                <div id="auth-status" class="text-3xl font-bold text-green-400">‚úì</div>
                <div class="text-xs text-purple-400 mt-1">ECDSA Verified</div>
            </div>
            </div>
            <div class="bg-gray-800 p-4 rounded-lg border-l-4 border-yellow-500">
                <div class="text-sm text-gray-400">MILEAGE</div>
                <div id="current-mileage" class="text-3xl font-bold">--</div>
                <div class="text-xs text-yellow-400 mt-1">OBD-II Data</div>
            </div>
        </div>

        <!-- Main Grid -->
        <div class="grid grid-cols-3 gap-6">
            <!-- Temperature Chart -->
            <div class="col-span-2 bg-gray-800 p-6 rounded-lg">
                <h2 class="text-2xl font-bold mb-4"> Temperature History</h2>
                <canvas id="temperatureChart" class="w-full h-64"></canvas>
                <div class="mt-4 grid grid-cols-3 gap-4 text-center">
                    <div>
                        <div class="text-sm text-gray-400">AVG TEMP</div>
                        <div id="avg-temp" class="text-2xl font-bold text-blue-400">--</div>
                    </div>
                    <div>
                        <div class="text-sm text-gray-400">MIN TEMP</div>
                        <div id="min-temp" class="text-2xl font-bold text-green-400">--</div>
                    </div>
                    <div>
                        <div class="text-sm text-gray-400">MAX TEMP</div>
                        <div id="max-temp" class="text-2xl font-bold text-red-400">--</div>
                    </div>
                </div>
            </div>

            <!-- System Status -->
            <div class="bg-gray-800 p-6 rounded-lg">
                <h2 class="text-2xl font-bold mb-4">üîß System Status</h2>
                
                <div class="space-y-4">
                    <!-- ESP32 Status -->
                    <div class="bg-gray-900 p-4 rounded">
                        <div class="flex items-center justify-between mb-2">
                            <span class="font-semibold">ESP32 Telematics</span>
                            <span id="esp32-status" class="text-green-400">‚óè Online</span>
                        </div>
                        <div class="text-sm text-gray-400">
                            <div>Sampling: <span id="sampling-freq" class="text-white">5s</span></div>
                            <div>Last Update: <span id="last-update" class="text-white">--</span></div>
                        </div>
                    </div>

                    <!-- Arduino Status -->
                    <div class="bg-gray-900 p-4 rounded">
                        <div class="flex items-center justify-between mb-2">
                            <span class="font-semibold">Arduino Auth</span>
                            <span id="arduino-status" class="text-green-400">‚óè Ready</span>
                        </div>
                        <div class="text-sm text-gray-400">
                            <div>Auth Method: <span class="text-white">ECDSA</span></div>
                            <div>Verified: <span id="verified-count" class="text-white">0</span></div>
                        </div>
                    </div>

                    <!-- Blockchain Status -->
                    <div class="bg-gray-900 p-4 rounded">
                        <div class="flex items-center justify-between mb-2">
                            <span class="font-semibold">Blockchain</span>
                            <span id="blockchain-status" class="text-green-400">‚óè Synced</span>
                        </div>
                        <div class="text-sm text-gray-400">
                            <div>Network: <span class="text-white">Hyperledger</span></div>
                            <div>Records: <span id="blockchain-records" class="text-white">--</span></div>
                        </div>
                    </div>

                    <!-- Diagnostic Codes -->
                    <div class="bg-gray-900 p-4 rounded">
                        <div class="font-semibold mb-2">Diagnostic Codes</div>
                        <div id="dtc-display" class="text-sm text-gray-400">
                            No codes detected
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Activity Log -->
        <div class="mt-6 bg-gray-800 p-6 rounded-lg">
            <h2 class="text-2xl font-bold mb-4"> Activity Log</h2>
            <div id="activity-log" class="space-y-1 max-h-64 overflow-y-auto font-mono text-xs">
                <div class="text-gray-400">Initializing dashboard...</div>
            </div>
        </div>

        <!-- FSM Diagram -->
        <div class="mt-6 bg-gray-800 p-6 rounded-lg">
            <h2 class="text-2xl font-bold mb-4"> Finite State Machine</h2>
            <div class="grid grid-cols-2 gap-6">
                <!-- ESP32 FSM -->
                <div>
                    <h3 class="text-lg font-semibold mb-3 text-blue-400">ESP32 Temperature FSM</h3>
                    <div class="bg-gray-900 p-4 rounded">
                        <div class="flex justify-around items-center">
                            <div id="fsm-normal" class="text-center p-4 rounded-lg bg-gray-700 transition-all">
                                <div class="text-2xl mb-2">üü¢</div>
                                <div class="font-semibold">NORMAL</div>
                                <div class="text-xs text-gray-400">T &lt; 30¬∞C</div>
                                <div class="text-xs text-gray-400">Freq: 5s</div>
                            </div>
                            <div class="text-2xl">‚Üí</div>
                            <div id="fsm-warning" class="text-center p-4 rounded-lg bg-gray-700 transition-all">
                                <div class="text-2xl mb-2">üü°</div>
                                <div class="font-semibold">WARNING</div>
                                <div class="text-xs text-gray-400">30-40¬∞C</div>
                                <div class="text-xs text-gray-400">Freq: 2s</div>
                            </div>
                            <div class="text-2xl">‚Üí</div>
                            <div id="fsm-critical" class="text-center p-4 rounded-lg bg-gray-700 transition-all">
                                <div class="text-2xl mb-2">üî¥</div>
                                <div class="font-semibold">CRITICAL</div>
                                <div class="text-xs text-gray-400">T &gt; 40¬∞C</div>
                                <div class="text-xs text-gray-400">Freq: 1s</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Arduino FSM -->
                <div>
                    <h3 class="text-lg font-semibold mb-3 text-purple-400">Arduino Authentication FSM</h3>
                    <div class="bg-gray-900 p-4 rounded">
                        <div class="flex flex-col space-y-3">
                            <div id="fsm-auth-waiting" class="p-3 rounded-lg bg-gray-700 transition-all">
                                <div class="flex items-center">
                                    <div class="text-xl mr-3">‚è≥</div>
                                    <div>
                                        <div class="font-semibold">WAITING</div>
                                        <div class="text-xs text-gray-400">Idle state</div>
                                    </div>
                                </div>
                            </div>
                            <div class="text-center">‚Üì</div>
                            <div id="fsm-auth-verifying" class="p-3 rounded-lg bg-gray-700 transition-all">
                                <div class="flex items-center">
                                    <div class="text-xl mr-3">üîê</div>
                                    <div>
                                        <div class="font-semibold">AUTHENTICATING</div>
                                        <div class="text-xs text-gray-400">Verifying ECDSA signature</div>
                                    </div>
                                </div>
                            </div>
                            <div class="text-center">‚Üì</div>
                            <div class="flex space-x-3">
                                <div id="fsm-auth-valid" class="flex-1 p-3 rounded-lg bg-gray-700 transition-all">
                                    <div class="text-center">
                                        <div class="text-xl mb-1">‚úÖ</div>
                                        <div class="font-semibold text-sm">VALID</div>
                                    </div>
                                </div>
                                <div id="fsm-auth-invalid" class="flex-1 p-3 rounded-lg bg-gray-700 transition-all">
                                    <div class="text-center">
                                        <div class="text-xl mb-1">‚ùå</div>
                                        <div class="font-semibold text-sm">INVALID</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="mt-6 text-center text-gray-500 text-sm">
            <p>Embedded Systems & IoT Project | 4-Subsystem Architecture</p>
            <p class="mt-1">ESP32 ‚Üí MQTT ‚Üí Control Unit ‚Üí Arduino ‚Üí Dashboard</p>
        </div>
    </div>

    <script>
        
        // CHART INITIALIZATION

        const ctx = document.getElementById('temperatureChart').getContext('2d');
        const temperatureChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Temperature (¬∞C)',
                    data: [],
                    borderColor: 'rgb(59, 130, 246)',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: false,
                        grid: { color: 'rgba(255, 255, 255, 0.1)' },
                        ticks: { color: 'rgba(255, 255, 255, 0.7)' }
                    },
                    x: {
                        grid: { color: 'rgba(255, 255, 255, 0.1)' },
                        ticks: { color: 'rgba(255, 255, 255, 0.7)' }
                    }
                },
                plugins: {
                    legend: {
                        labels: { color: 'rgba(255, 255, 255, 0.9)' }
                    }
                }
            }
        });

        // STATE MANAGEMENT

        let verifiedCount = 0;
        let blockchainRecords = 0;

        // DATA FETCHING

        async function fetchLatestTelemetry() {
            try {
                const response = await fetch('http://localhost:3002/api/telemetry/latest');
                const result = await response.json();

                if (result.success && result.data) {
                    updateDashboard(result.data, result.state);
                }
            } catch (error) {
                addLog('‚ùå Failed to fetch telemetry: ' + error.message, 'error');
            }
        }

        async function fetchStatistics() {
            try {
                const response = await fetch('http://localhost:3002/api/telemetry/statistics');
                const result = await response.json();

                if (result.success) {
                    updateStatistics(result.stats);
                }
            } catch (error) {
                console.error('Failed to fetch statistics:', error);
            }
        }

        async function fetchHistory() {
            try {
                const response = await fetch('http://localhost:3002/api/telemetry/history');
                const result = await response.json();

                if (result.success && result.data) {
                    updateChart(result.data);
                }
            } catch (error) {
                console.error('Failed to fetch history:', error);
            }
        }

        // DASHBOARD UPDATE FUNCTIONS

        function updateDashboard(data, state) {
            // Update temperature
            const temp = parseFloat(data.temp);
            document.getElementById('current-temp').textContent = temp.toFixed(1) + '¬∞C';

            // Update system state
            document.getElementById('system-state').textContent = state;
            updateFSMDisplay(state);

            // Update mileage
            document.getElementById('current-mileage').textContent = data.mileage + ' km';

            // Update DTC
            if (data.dtc) {
                document.getElementById('dtc-display').innerHTML = `
                    <span class="text-red-400">‚ö†Ô∏è ${data.dtc}</span>
                `;
                addLog(`‚ö†Ô∏è Diagnostic code detected: ${data.dtc}`, 'warning');
            }

            // Update last seen
            const now = new Date();
            document.getElementById('last-update').textContent = now.toLocaleTimeString();

            // Update sampling frequency based on state
            const freqMap = { 'NORMAL': '5s', 'WARNING': '2s', 'CRITICAL': '1s' };
            document.getElementById('sampling-freq').textContent = freqMap[state] || '5s';

            // Update authentication status
            verifiedCount++;
            document.getElementById('verified-count').textContent = verifiedCount;
            document.getElementById('auth-status').innerHTML = '‚úì';

            // Log activity
            addLog(`üì° Telemetry received: ${temp.toFixed(1)}¬∞C | State: ${state}`, 'info');
        }

        function updateStatistics(stats) {
            document.getElementById('avg-temp').textContent = stats.avg.toFixed(1) + '¬∞C';
            document.getElementById('min-temp').textContent = stats.min.toFixed(1) + '¬∞C';
            document.getElementById('max-temp').textContent = stats.max.toFixed(1) + '¬∞C';
            document.getElementById('blockchain-records').textContent = stats.count;
        }

        function updateChart(history) {
            const maxDataPoints = 20;
            const recentData = history.slice(-maxDataPoints);

            const labels = recentData.map((item, index) => {
                const time = new Date(item.receivedAt);
                return time.toLocaleTimeString();
            });

            const temps = recentData.map(item => parseFloat(item.temp));

            temperatureChart.data.labels = labels;
            temperatureChart.data.datasets[0].data = temps;
            temperatureChart.update();
        }

        function updateFSMDisplay(state) {
            // Reset all states
            document.getElementById('fsm-normal').className = 'text-center p-4 rounded-lg bg-gray-700 transition-all';
            document.getElementById('fsm-warning').className = 'text-center p-4 rounded-lg bg-gray-700 transition-all';
            document.getElementById('fsm-critical').className = 'text-center p-4 rounded-lg bg-gray-700 transition-all';

            // Highlight current state
            if (state === 'NORMAL') {
                document.getElementById('fsm-normal').className = 'text-center p-4 rounded-lg bg-green-700 transition-all shadow-lg';
            } else if (state === 'WARNING') {
                document.getElementById('fsm-warning').className = 'text-center p-4 rounded-lg bg-yellow-700 transition-all shadow-lg';
            } else if (state === 'CRITICAL') {
                document.getElementById('fsm-critical').className = 'text-center p-4 rounded-lg bg-red-700 transition-all shadow-lg';
            }
        }

        function addLog(message, type = 'info') {
            const logDiv = document.getElementById('activity-log');
            const timestamp = new Date().toLocaleTimeString();
            const icon = type === 'error' ? '‚ùå' : type === 'warning' ? '‚ö†Ô∏è' : type === 'success' ? '‚úÖ' : '‚ÑπÔ∏è';

            const logEntry = document.createElement('div');
            logEntry.className = `text-${type === 'error' ? 'red' : type === 'warning' ? 'yellow' : type === 'success' ? 'green' : 'gray'}-400`;
            logEntry.textContent = `[${timestamp}] ${icon} ${message}`;

            logDiv.insertBefore(logEntry, logDiv.firstChild);

            // Keep only last 50 logs
            if (logDiv.children.length > 50) {
                logDiv.removeChild(logDiv.lastChild);
            }
        }

        // ========================================================================
        // INITIALIZATION
        // ========================================================================

        function initialize() {
            addLog(' Dashboard initialized', 'success');
            addLog(' Connecting to Control Unit (http://localhost:3002)', 'info');
            addLog(' Waiting for authenticated telemetry data...', 'info');

            // Start polling
            fetchLatestTelemetry();
            fetchStatistics();
            fetchHistory();

            setInterval(fetchLatestTelemetry, 2000); // Every 2 seconds
            setInterval(fetchStatistics, 5000); // Every 5 seconds
            setInterval(fetchHistory, 10000); // Every 10 seconds
        }

        // Start dashboard
        initialize();
    </script>
</body>
</html>
